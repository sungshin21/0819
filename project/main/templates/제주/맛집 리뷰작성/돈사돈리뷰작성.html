<!doctype html>
{% load static %}
<html lang="ko">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 구글 폰트: main.css보다 먼저 불러올 수 있도록 한다 -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Noto+Sans+KR:wght@400;500&display=swap" rel="stylesheet">
    <!-- Google Material Design -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
    <!-- 부트스트랩 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!-- 파비콘(favorite icon) 설정 -->
    <link rel="icon" href="{% static 'css/world.png' %}" />
    <!--jquery -->
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
    <!-- 맛집 리뷰 css -->
    <link rel="stylesheet" href="{% static 'css/맛집,명소 공통 리뷰.css' %}">
    <!-- 맛집 리뷰 js -->
    <script defer src="{% static 'js/맛집 리뷰 공통.js' %}"></script>
    <!-- 타이틀 -->
    <title>전국 여행의 시작, 이곳저곳</title>
  </head>
  <body>
    <div class="container">
      <form action="">
      <nav id="outside__menu"></nav>
      <div id="review">
        <div id="review-item">
          <!--리뷰참여 팝업창-->
          
          
  
         <!-- 리뷰참여 창: 누르면 뜨는 창-->
          <nav id="pop">

            <a class="review-contentname1"><img id="review-logo" src="{% static 'css/world.png' %}" alt="logo"><p>리뷰 참여하기</p></a>  
            <hr>
  
            <div class="name">
              <p class="review-content">닉네임 설정하기</p>
              <div class="review-commenting">
                <textarea class="form-name" aria-label="With textarea"></textarea>
              </div>        
            </div>   
            
            <div class="review_rating">
              <p class="review-content">별점</p>
              <div class="warning_msg">별점을 선택해 주세요.</div>
              <div class="rating">
                  <!-- 해당 별점을 클릭하면 해당 별과 그 왼쪽의 모든 별의 체크박스에 checked 적용 -->
                  <input type="checkbox" name="rating" id="rating1" value="1" class="rate_radio" title="1점">
                  <label for="rating1"></label>
                  <input type="checkbox" name="rating" id="rating2" value="2" class="rate_radio" title="2점">
                  <label for="rating2"></label>
                  <input type="checkbox" name="rating" id="rating3" value="3" class="rate_radio" title="3점" >
                  <label for="rating3"></label>
                  <input type="checkbox" name="rating" id="rating4" value="4" class="rate_radio" title="4점">
                  <label for="rating4"></label>
                  <input type="checkbox" name="rating" id="rating5" value="5" class="rate_radio" title="5점">
                  <label for="rating5"></label>
              </div></div>
            <p class="review-content">가격(가성비)</p>
            <class class="review-pricing">
                <a style="color: rgb(0, 17, 255);font-family: 'Nanum Gothic', sans-serif; font-weight: 700; font-size: 12px;">나쁨</a>
               <input type="range" class="form-range" min="1" max="3" step="0.5" id="customRange3">
               <a style="color: rgb(0, 17, 255);font-family: 'Nanum Gothic', sans-serif; font-weight: 700; font-size: 12px;">좋음</a>
               <p class="review-content review-number">-2 -1 0 1 2</p>
             </class>
            <p class="review-content">누구와의 방문</p>
            <div class="btn-group">
              <button id="family" type="button" class="btn btn-sm btn-outline-secondary">가족</button>
              <button id="friend" type="button" class="btn btn-sm btn-outline-secondary">친구</button>
              <button id="lover" type="button" class="btn btn-sm btn-outline-secondary">연인</button>
              <button id="other" type="button" class="btn btn-sm btn-outline-secondary">기타</button>
            </div> 
                    
            <p class="review-content">의견</p>
            <div class="review-commenting">
              <span class="input-group-text">의견 남기기</span>
              <textarea id="comment" class="form-control" aria-label="With textarea"></textarea>            
            </div>
            <div id="submit">
              <button class="submit"  _msthash="1634243" _msttexthash="21528260" onclick="submitReview()">제출</button>
            </div>
  
  
          </nav>
        </div>
      </div> 
    </form>
  </div>

  <script>
    const form = document.querySelector('form');

    form.addEventListener('submit', function(e) {
      // 페이지 이동 방지
      e.preventDefault();
      console.log('submit!')
    })
    // 작성한 리뷰 서버로 전송

    function submitReview() {

      const name = '돈사돈';
      const nickname = document.querySelector('.form-name').value;

      const rating1 = document.querySelector('#rating1').checked;
      const rating2 = document.querySelector('#rating2').checked;
      const rating3 = document.querySelector('#rating3').checked;
      const rating4 = document.querySelector('#rating4').checked;
      const rating5 = document.querySelector('#rating5').checked;

      const priceRateFormValue = document.querySelector('.form-range').value;

      const family = document.querySelector('#family').style.color == 'rgb(255, 255, 255)'
      const friend = document.querySelector('#friend').style.color == 'rgb(255, 255, 255)'
      const lover = document.querySelector('#lover').style.color == 'rgb(255, 255, 255)'
      const other = document.querySelector('#other').style.color == 'rgb(255, 255, 255)'

      const comment = document.querySelector('#comment').value;

      let rate = null;
      if (rating5) {
        rate = 5;
      } else if (rating4) {
        rate = 4;
      } else if (rating3) {
        rate = 3;
      } else if (rating2) {
        rate = 2;
      } else if (rating1) {
        rate = 1;
      }

      let companion = null;
      if (family) {
        companion = 'family'
      } else if (friend) {
        companion = 'friend'
      } else if (lover) {
        companion = 'lover'
      } else if (other) {
        companion = 'other'
      }

      let priceRate = null;
      if (priceRateFormValue == 1) {
        priceRate = -2
      } else if (priceRateFormValue == 1.5) {
        priceRate = -1
      } else if (priceRateFormValue == 2) {
        priceRate = 0
      } else if (priceRateFormValue == 2.5) {
        priceRate = 1
      } else if (priceRateFormValue == 3) {
        priceRate = 2
      }

      // 누락된 필드가 있으면 안됨
      if (!nickname || !rate || !companion || !comment || !priceRate) {
        alert('리뷰가 완성되지 않았습니다.')
        return;
      }
      
      // API 바인딩
      fetch('http://localhost:3000/restaurant/review', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({name, nickname, rate, priceRate, companion,comment})
      }).then(() => {
        alert('리뷰가 등록되었습니다.')
        location.reload();
      }).catch((e) => {
        alert('서버 에러가 발생하였습니다.')
        console.log(e);
      })
    }

  </script>
  </body>
</html>